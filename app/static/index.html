<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TG-Dispatcher Control Plane</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&family=JetBrains+Mono&display=swap"
        rel="stylesheet">
    <!-- CodeMirror Ê†∑Âºè -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/material-ocean.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/yaml/yaml.min.js"></script>
    <style>
        :root {
            --bg-dark: #0a0a0c;
            --card-bg: #16161a;
            --accent: #6366f1;
            --text-main: #e2e8f0;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Outfit', sans-serif;
            overflow-x: hidden;
        }

        .glass {
            background: rgba(22, 22, 26, 0.7);
            -webkit-backdrop-filter: blur(14px);
            backdrop-filter: blur(14px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 16px;
        }

        .CodeMirror {
            height: 500px;
            border-radius: 12px;
            font-family: 'JetBrains Mono';
            font-size: 14px;
            padding: 10px;
        }

        .tab-btn.active {
            border-bottom: 2px solid var(--accent);
            color: white;
        }

        .gradient-text {
            background: linear-gradient(135deg, #818cf8 0%, #c084fc 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .btn-primary {
            background: var(--accent);
            transition: all 0.2s;
        }

        .btn-primary:hover {
            filter: brightness(1.2);
            transform: translateY(-1px);
        }
    </style>
</head>

<body class="min-h-screen">

    <div id="login-screen" class="fixed inset-0 flex items-center justify-center z-[100] bg-black/90 backdrop-blur-md">
        <div class="glass p-10 w-full max-w-md text-center">
            <h1 class="text-4xl font-bold mb-8 gradient-text">Control Center</h1>
            <input type="password" id="password" placeholder="Admin Access Key"
                class="w-full bg-white/5 border border-white/10 p-4 rounded-xl mb-6 focus:outline-none focus:border-indigo-500 transition-all text-center text-lg">
            <button onclick="login()"
                class="w-full btn-primary p-4 rounded-xl font-bold text-lg shadow-lg shadow-indigo-500/20">
                Unlock System
            </button>
        </div>
    </div>

    <main id="main-content" class="hidden">
        <nav class="border-b border-white/5 bg-black/50 sticky top-0 z-40 backdrop-blur-md">
            <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
                <h2 class="text-2xl font-bold gradient-text">Dispatcher Console</h2>
                <div class="flex gap-8 text-sm font-medium text-slate-400">
                    <button onclick="switchTab('dashboard')" class="tab-btn active px-2 py-1 transition-all"
                        id="btn-dashboard">üìä Dashboard</button>
                    <button onclick="switchTab('config')" class="tab-btn px-2 py-1 transition-all" id="btn-config">‚öôÔ∏è
                        Config Editor</button>
                    <button onclick="logout()" class="hover:text-red-400 transition-all">Logout</button>
                </div>
            </div>
        </nav>

        <div class="max-w-7xl mx-auto p-6">
            <!-- Tab: Dashboard -->
            <div id="tab-dashboard" class="space-y-8 animate-in fade-in duration-500">
                <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                    <div class="glass p-4 border-l-4 border-indigo-500">
                        <p class="text-slate-500 text-[10px] mb-1 uppercase tracking-tighter">Ê¥ªË∑É‰ªªÂä°</p>
                        <h3 id="st-tasks" class="text-2xl font-bold">0</h3>
                    </div>
                    <div class="glass p-4 border-l-4 border-purple-500">
                        <p class="text-slate-500 text-[10px] mb-1 uppercase tracking-tighter">ÁõëÂê¨Áæ§ÁªÑ</p>
                        <h3 id="st-sources" class="text-2xl font-bold">0</h3>
                    </div>
                    <div class="glass p-4">
                        <p class="text-slate-500 text-[10px] mb-1 uppercase tracking-tighter">ËøêË°åÂë®Êúü</p>
                        <h3 id="st-cycles" class="text-2xl font-bold">0</h3>
                    </div>
                    <div class="glass p-4">
                        <p class="text-slate-500 text-[10px] mb-1 uppercase tracking-tighter">Ê∂àÊÅØÊµÅ</p>
                        <h3 id="st-msgs" class="text-2xl font-bold">0</h3>
                    </div>
                    <div class="glass p-4">
                        <p class="text-slate-500 text-[10px] mb-1 uppercase tracking-tighter">ËØÜÂà´URL</p>
                        <h3 id="st-urls" class="text-2xl font-bold">0</h3>
                    </div>
                    <div class="glass p-4">
                        <p class="text-slate-500 text-[10px] mb-1 uppercase tracking-tighter">Áä∂ÊÄÅ</p>
                        <h3 id="sys-status" class="text-base font-bold text-emerald-400">Loading</h3>
                    </div>
                </div>

                <div class="glass p-6">
                    <h3 class="text-lg font-bold mb-4 opacity-70">Á≥ªÁªüÂÆûÊó∂ÊµÅÊ∞¥ËÆ∞ÂΩï</h3>
                    <div id="log-box"
                        class="h-[400px] overflow-y-auto font-mono text-sm space-y-2 p-4 bg-black/30 rounded-xl border border-white/5">
                    </div>
                </div>
            </div>

            <!-- Tab: Config Editor -->
            <div id="tab-config" class="hidden space-y-6">
                <div class="flex gap-4 mb-4">
                    <button onclick="loadConfig('config')" id="sel-config"
                        class="bg-white/5 px-4 py-2 rounded-lg font-bold">Task Config (config.yaml)</button>
                    <button onclick="loadConfig('rules')" id="sel-rules"
                        class="bg-white/5 px-4 py-2 rounded-lg font-medium opacity-50">Cleaning Rules
                        (rules.yaml)</button>
                </div>
                <div class="glass overflow-hidden">
                    <textarea id="editor" aria-label="Config Editor"></textarea>
                </div>
                <div class="flex justify-end gap-4">
                    <span id="save-status" class="text-emerald-400 py-3 hidden">Saved Successfully!</span>
                    <button onclick="saveCurrentConfig()"
                        class="btn-primary px-8 py-3 rounded-xl font-bold shadow-xl shadow-indigo-500/10">
                        Apply & Hot Reload
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script>
        let token = localStorage.getItem('dt_token');
        let editor = null;
        let currentEditingFile = 'config';

        if (token) init();

        // ÊîØÊåÅÂõûËΩ¶ÁôªÂΩï
        document.getElementById('password').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') login();
        });

        async function login() {
            const pwd = document.getElementById('password').value;
            const res = await fetch('/token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `username=admin&password=${pwd}`
            });
            if (res.ok) {
                const data = await res.json();
                token = data.access_token;
                localStorage.setItem('dt_token', token);
                init();
            } else alert('Access Denied');
        }

        function init() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
                mode: 'yaml', theme: 'material-ocean', lineNumbers: true, indentUnit: 2
            });
            startPolling();
        }

        function logout() { localStorage.removeItem('dt_token'); location.reload(); }

        function switchTab(tab) {
            document.getElementById('tab-dashboard').classList.toggle('hidden', tab !== 'dashboard');
            document.getElementById('tab-config').classList.toggle('hidden', tab !== 'config');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-' + tab).classList.add('active');
            if (tab === 'config') {
                loadConfig(currentEditingFile);
                setTimeout(() => editor.refresh(), 100);
            }
        }

        async function loadConfig(type) {
            currentEditingFile = type;
            const res = await fetch(`/api/${type}`, { headers: { 'Authorization': `Bearer ${token}` } });
            const content = await res.json();
            editor.setValue(content);
            document.getElementById('sel-config').style.opacity = type === 'config' ? '1' : '0.5';
            document.getElementById('sel-rules').style.opacity = type === 'rules' ? '1' : '0.5';
        }

        async function saveCurrentConfig() {
            const content = editor.getValue();
            const res = await fetch(`/api/${currentEditingFile}`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({ content })
            });
            if (res.ok) {
                const status = document.getElementById('save-status');
                status.classList.remove('hidden');
                setTimeout(() => status.classList.add('hidden'), 3000);
            } else {
                const err = await res.json(); alert('Save Error: ' + err.detail);
            }
        }

        function startPolling() {
            setInterval(async () => {
                try {
                    const res = await fetch('/api/stats', { headers: { 'Authorization': `Bearer ${token}` } });
                    if (res.status === 401) logout();
                    const data = await res.json();
                    document.getElementById('st-tasks').innerText = data.tasks_active;
                    document.getElementById('st-sources').innerText = data.sources_active;
                    document.getElementById('st-cycles').innerText = data.cycles_completed;
                    document.getElementById('st-msgs').innerText = data.messages_processed;
                    document.getElementById('st-urls').innerText = data.urls_identified;
                    document.getElementById('sys-status').innerText = data.status;


                    const logContainer = document.getElementById('log-box');
                    // Newest logs at the top (monitor.py inserts at index 0)
                    logContainer.innerHTML = data.logs.map(l => `
                        <div class="text-slate-300 transition-all hover:bg-white/5 p-1 rounded flex gap-3">
                            <span class="text-indigo-500/50 font-mono">[${l.time}]</span>
                            <span class="flex-1">${l.msg}</span>
                        </div>
                    `).join('');
                } catch (e) { }
            }, 2000);
        }
    </script>
</body>

</html>